{
  "id": "S3-05",
  "name": "Multiple Credential Harvest",
  "category": "CI/CD & Supply Chain",
  "version": "1.0",
  "description": "Rapid systematic enumeration of all available credential files on a compromised system to maximize attack surface",
  "difficulty": "Medium",
  "real_world_relevance": "Post-exploitation credential harvesting is standard practice; automated tools like LaZagne, mimikatz, and custom scripts enumerate all credential stores simultaneously",

  "mitre_attack": {
    "tactics": ["Credential Access", "Discovery"],
    "techniques": [
      {"id": "T1552", "name": "Unsecured Credentials"},
      {"id": "T1083", "name": "File and Directory Discovery"}
    ]
  },

  "prerequisites": {
    "containers": ["cloud-workload"],
    "network": "cloud_net"
  },

  "attack_flow": {
    "description": "Attacker rapidly enumerates all credential files in a single sweep",
    "diagram": [
      "1. Attacker gains shell access to cloud workload",
      "2. Attacker runs one-liner to check all known credential locations",
      "3. AWS credentials, SSH keys, git creds, Vault tokens, .env files accessed in rapid succession",
      "4. Wazuh correlation rule fires detecting multi-credential harvesting",
      "5. Attacker selects highest-value credentials for next attack phase"
    ]
  },

  "phases": [
    {
      "name": "Mass Credential Sweep",
      "description": "Access multiple credential files in rapid succession",
      "critical": true,
      "actions": [
        {
          "type": "command",
          "command": "cat ~/.aws/credentials 2>/dev/null || true; cat ~/.ssh/id_rsa 2>/dev/null | head -5 || true; cat ~/.git-credentials 2>/dev/null || true; cat ~/.vault-token 2>/dev/null || true; cat /app/.env 2>/dev/null || true",
          "description": "Access all known credential file locations in one sweep"
        }
      ]
    }
  ],

  "indicators_of_compromise": [
    {
      "type": "File Access",
      "description": "Multiple credential file accesses by same user within short timeframe",
      "wazuh_rule": "100609"
    },
    {
      "type": "Correlation",
      "description": "Frequency-based detection of credential harvesting pattern",
      "wazuh_rule": "100609"
    }
  ],

  "expected_wazuh_alerts": [
    {
      "rule_id": "100601",
      "level": 12,
      "description": "NHI: AWS credentials file access detected"
    },
    {
      "rule_id": "100602",
      "level": 10,
      "description": "NHI: SSH private key access detected"
    },
    {
      "rule_id": "100603",
      "level": 10,
      "description": "NHI: Git credential file access detected"
    },
    {
      "rule_id": "100606",
      "level": 10,
      "description": "NHI: HashiCorp Vault token file access"
    },
    {
      "rule_id": "100600",
      "level": 10,
      "description": "NHI: Environment configuration file access detected"
    },
    {
      "rule_id": "100609",
      "level": 14,
      "description": "NHI: Multiple credential file accesses by same user - credential harvesting"
    }
  ],

  "remediation": {
    "immediate": [
      "Rotate ALL credentials on the compromised system",
      "Isolate the compromised workload from the network",
      "Audit access logs for lateral movement using stolen credentials"
    ],
    "long_term": [
      "Implement credential-free authentication (workload identity, IRSA, WIF)",
      "Use secrets management instead of credential files",
      "Deploy file integrity monitoring (FIM) on credential paths",
      "Implement zero-trust network segmentation",
      "Use ephemeral credentials with short TTLs"
    ]
  },

  "demo_script": {
    "container": "cloud-workload",
    "commands": [
      "# Rapid credential harvest (triggers correlation rule 100609)",
      "cat ~/.aws/credentials 2>/dev/null || true",
      "cat ~/.ssh/id_rsa 2>/dev/null | head -5 || true",
      "cat ~/.git-credentials 2>/dev/null || true",
      "cat ~/.vault-token 2>/dev/null || true",
      "cat /app/.env 2>/dev/null || true"
    ]
  },

  "references": [
    {
      "title": "MITRE ATT&CK T1552 - Unsecured Credentials",
      "url": "https://attack.mitre.org/techniques/T1552/"
    },
    {
      "title": "MITRE ATT&CK T1083 - File and Directory Discovery",
      "url": "https://attack.mitre.org/techniques/T1083/"
    }
  ]
}
