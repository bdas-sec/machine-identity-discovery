{
  "id": "S4-04",
  "name": "Secrets Mounted in Pod",
  "category": "Kubernetes",
  "version": "1.0",
  "description": "Access sensitive secrets mounted as volumes or environment variables in pods",
  "difficulty": "Easy",
  "real_world_relevance": "Common Kubernetes secret exposure, database credentials in pods",

  "mitre_attack": {
    "tactics": ["Credential Access", "Collection"],
    "techniques": [
      {"id": "T1552.001", "name": "Unsecured Credentials: Credentials In Files"},
      {"id": "T1552.007", "name": "Unsecured Credentials: Container API"}
    ]
  },

  "prerequisites": {
    "containers": ["k8s-node"],
    "network": "k8s_net"
  },

  "attack_flow": {
    "description": "Attacker extracts secrets from volume mounts and environment variables",
    "diagram": [
      "1. Attacker gains access to pod (RCE, supply chain)",
      "2. Attacker checks environment variables for secrets",
      "3. Attacker searches for mounted secret volumes",
      "4. Attacker extracts database credentials, API keys",
      "5. Attacker uses credentials for lateral movement"
    ]
  },

  "phases": [
    {
      "name": "Environment Variable Search",
      "description": "Check for secrets in environment variables",
      "actions": [
        {
          "type": "command",
          "command": "env | grep -iE '(password|secret|token|key|api)'",
          "expected_output_contains": ["DATABASE_PASSWORD", "API_KEY"]
        }
      ]
    },
    {
      "name": "Volume Mount Discovery",
      "description": "Find mounted secret volumes",
      "actions": [
        {
          "type": "command",
          "command": "mount | grep secret",
          "expected_output_contains": ["tmpfs", "/var/run/secrets"]
        },
        {
          "type": "command",
          "command": "find / -path '*secrets*' -type f 2>/dev/null",
          "description": "Search for secret files"
        }
      ]
    },
    {
      "name": "Secret Extraction",
      "description": "Read secret values from mounts",
      "critical": true,
      "actions": [
        {
          "type": "command",
          "command": "cat /etc/secrets/db-password",
          "expected_output_contains": ["SuperSecretPassword"]
        },
        {
          "type": "command",
          "command": "cat /etc/secrets/api-key",
          "description": "Read API key from mounted secret"
        }
      ]
    },
    {
      "name": "Credential Use",
      "description": "Use extracted credentials",
      "actions": [
        {
          "type": "command",
          "command": "mysql -h db-server -u app -p$(cat /etc/secrets/db-password)",
          "description": "Connect to database with stolen credentials"
        }
      ]
    }
  ],

  "indicators_of_compromise": [
    {
      "type": "File Access",
      "description": "Read access to secret volume mounts",
      "wazuh_rule": "100759"
    },
    {
      "type": "Process",
      "description": "Commands extracting secret values",
      "wazuh_rule": "100760"
    },
    {
      "type": "Process",
      "description": "Environment enumeration for credentials",
      "wazuh_rule": "100761"
    }
  ],

  "expected_wazuh_alerts": [
    {
      "rule_id": "100759",
      "level": 10,
      "description": "NHI: Kubernetes secret volume accessed"
    },
    {
      "rule_id": "100760",
      "level": 12,
      "description": "NHI: Secret extraction from pod - CREDENTIAL THEFT"
    },
    {
      "rule_id": "100761",
      "level": 8,
      "description": "NHI: Environment variable enumeration for credentials"
    }
  ],

  "remediation": {
    "immediate": [
      "Rotate all exposed secrets",
      "Review pod security and access patterns",
      "Terminate compromised pod"
    ],
    "long_term": [
      "Use external secret management (Vault, AWS Secrets Manager)",
      "Implement secret rotation policies",
      "Use Kubernetes External Secrets Operator",
      "Encrypt secrets at rest with KMS"
    ],
    "external_secrets": {
      "apiVersion": "external-secrets.io/v1beta1",
      "kind": "ExternalSecret",
      "metadata": {"name": "db-credentials"},
      "spec": {
        "refreshInterval": "1h",
        "secretStoreRef": {"name": "vault-backend", "kind": "ClusterSecretStore"},
        "target": {"name": "db-secret"},
        "data": [
          {"secretKey": "password", "remoteRef": {"key": "database/credentials", "property": "password"}}
        ]
      }
    },
    "vault_integration": [
      "# Use Vault Agent injector",
      "annotations:",
      "  vault.hashicorp.com/agent-inject: 'true'",
      "  vault.hashicorp.com/role: 'app-role'",
      "  vault.hashicorp.com/agent-inject-secret-db: 'database/creds/app'"
    ]
  },

  "demo_script": {
    "container": "k8s-node",
    "commands": [
      "# Check for secrets in environment",
      "env | grep -iE '(password|secret|token)' | head -5",
      "",
      "# Find mounted secrets",
      "find /etc/secrets /var/run/secrets -type f 2>/dev/null",
      "",
      "# Read secret (simulated)",
      "cat /etc/secrets/demo-password 2>/dev/null || echo 'Demo secret: SuperSecretP@ssw0rd!'"
    ]
  },

  "references": [
    {
      "title": "Kubernetes Secrets",
      "url": "https://kubernetes.io/docs/concepts/configuration/secret/"
    },
    {
      "title": "External Secrets Operator",
      "url": "https://external-secrets.io/"
    },
    {
      "title": "Vault Kubernetes Integration",
      "url": "https://developer.hashicorp.com/vault/docs/platform/k8s"
    }
  ]
}
