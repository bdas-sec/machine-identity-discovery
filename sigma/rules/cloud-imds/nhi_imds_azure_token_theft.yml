title: "NHI: Azure Managed Identity Token Request - Credential Theft"
id: 803a46a9-eb0e-4e2c-ab15-7c5ebee52eff
related:
    - id: "100656"
      type: derived
status: test
description: |
    Detects Azure managed identity token requests via IMDS oauth2/token endpoint.
    This is the final step in extracting Azure AD tokens from compromised VMs,
    enabling access to Azure resources with the VM's managed identity permissions.
    Derived from Wazuh rule 100656 (child of 100655).
references:
    - https://attack.mitre.org/techniques/T1552/005/
    - https://attack.mitre.org/techniques/T1078/004/
author: Bodhisattva Das
date: 2026-02-15
tags:
    - attack.credential_access
    - attack.t1552.005
    - attack.t1078.004
    - nhi.cloud_imds
logsource:
    category: network_connection
    product: linux
detection:
    selection_imds:
        dst_ip: '169.254.169.254'
    selection_identity:
        url|contains: 'metadata/identity'
    selection_token:
        url|contains: 'oauth2/token'
    condition: selection_imds and selection_identity and selection_token
falsepositives:
    - Azure SDK automatic token refresh
level: high
